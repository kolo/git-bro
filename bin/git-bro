#! /usr/bin/ruby

require 'git-bro'
require 'sinatra'
require 'haml'
require 'sass'
require 'git-bro/sinatra/helpers'

begin
  if ARGV.size != 1
    puts 'USAGE: ruby git-bro <path to git repository>'
    exit 1
  end
  repository = GitBro::Repository.new(ARGV[0])
rescue ArgumentError
  puts 'Cannot locate a repository in given path'
  exit 1
end

# Routes

get '/' do
  @path = repository.path
  @objs = repository.root
  haml :index
end

get '/:branch/*' do
  puts params['splat']
  if params['splat'][0][-1..-1] == "/"
    # dir
    @path_prefix = params[:branch] + '/' + params['splat'][0]
    @path = repository.path + @path_prefix
    @objs = repository.tree("#{params['splat'][0]}", params[:sha])
    haml :dir_listing
  else
    # file
    @content = repository.file_content(params[:sha])
    haml :file_content
  end
end

get '/application.css' do
  content_type 'text/css', :charset => 'utf-8'
  sass :application
end
